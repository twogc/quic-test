# 2GC Network Protocol Suite - Server Dockerfile
# Оптимизированный образ для QUIC сервера

FROM golang:1.25.1-alpine AS builder

# Установка зависимостей
RUN apk add --no-cache git make

# Установка рабочей директории
WORKDIR /app

# Копирование go.mod и go.sum для кэширования зависимостей
COPY go.mod go.sum ./
RUN go mod download

# Копирование исходного кода
COPY . .

# Сборка только сервера
RUN make build-server

# Runtime образ
FROM alpine:3.20

# Установка зависимостей runtime
RUN apk add --no-cache ca-certificates tzdata wget

# Создание пользователя для безопасности
RUN addgroup -g 1001 -S quic && \
    adduser -u 1001 -S quic -G quic

# Установка рабочей директории
WORKDIR /app

# Копирование собранного сервера
COPY --from=builder /app/build/quic-server ./
COPY --from=builder /app/tag.txt ./

# Установка прав доступа
RUN chown -R quic:quic /app
USER quic

# Открытие портов
EXPOSE 9000 2113 6060

# Переменные окружения
ENV QUIC_SERVER_ADDR=:9000
ENV QUIC_PROMETHEUS_SERVER_PORT=2113
ENV QUIC_PPROF_ADDR=:6060

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:2113/metrics || exit 1

# Метки для контейнера
LABEL org.opencontainers.image.title="2GC Network Protocol Suite - Server"
LABEL org.opencontainers.image.description="QUIC server for network protocol testing"
LABEL org.opencontainers.image.url="https://github.com/twogc/quic-test"
LABEL org.opencontainers.image.source="https://github.com/twogc/quic-test"
LABEL org.opencontainers.image.licenses="Apache-2.0"
LABEL org.opencontainers.image.vendor="2GC"

# Команда по умолчанию - запуск сервера
CMD ["./quic-server", "--addr=:9000", "--prometheus", "--pprof-addr=:6060"]
