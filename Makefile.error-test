# 2GC Network Protocol Suite - Error Testing
# ÐšÐ¾Ð¼Ð¿Ð»ÐµÐºÑÐ½Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð½Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ¸

.PHONY: help build-error-test test-error-scenarios clean-error-test run-error-test

# ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ
ERROR_TEST_BINARY := quic-test-error-test
ERROR_TEST_CMD := ./cmd/error-test
RESULTS_DIR := ./error-test-results

help: ## ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÐ¿Ñ€Ð°Ð²ÐºÑƒ Ð¿Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
	@echo "ðŸ§ª 2GC Network Protocol Suite - Error Testing"
	@echo "============================================"
	@echo ""
	@echo "Error Testing Features:"
	@echo "  - Network error simulation (packet loss, corruption, reordering)"
	@echo "  - QUIC protocol error testing"
	@echo "  - Experimental features error testing"
	@echo "  - Recovery time measurement"
	@echo "  - Performance impact analysis"
	@echo ""
	@echo "Available commands:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-25s\033[0m %s\n", $$1, $$2}'

build-error-test: ## Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
	@echo "ðŸ§ª Building error testing tool..."
	@mkdir -p $(RESULTS_DIR)
	go build -o $(ERROR_TEST_BINARY) $(ERROR_TEST_CMD)
	@echo "âœ… Error testing binary built: $(ERROR_TEST_BINARY)"

test-error-scenarios: build-error-test ## Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð¿Ñ€ÐµÐ´ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¸ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
	@echo "ðŸ§ª Running all error testing scenarios..."
	@echo ""
	@echo "Scenario 1: Network Stress Test"
	./$(ERROR_TEST_BINARY) -scenario=network-stress -verbose -output=$(RESULTS_DIR)/network-stress.json
	@echo ""
	@echo "Scenario 2: QUIC Protocol Error Test"
	./$(ERROR_TEST_BINARY) -scenario=quic-protocol-errors -verbose -output=$(RESULTS_DIR)/quic-protocol.json
	@echo ""
	@echo "Scenario 3: Experimental Features Error Test"
	./$(ERROR_TEST_BINARY) -scenario=experimental-features -verbose -output=$(RESULTS_DIR)/experimental.json
	@echo ""
	@echo "Scenario 4: High Latency Network Test"
	./$(ERROR_TEST_BINARY) -scenario=high-latency-network -verbose -output=$(RESULTS_DIR)/high-latency.json
	@echo ""
	@echo "Scenario 5: Unstable Connection Test"
	./$(ERROR_TEST_BINARY) -scenario=unstable-connection -verbose -output=$(RESULTS_DIR)/unstable.json
	@echo ""
	@echo "Scenario 6: Congestion Control Stress Test"
	./$(ERROR_TEST_BINARY) -scenario=congestion-control-stress -verbose -output=$(RESULTS_DIR)/cc-stress.json
	@echo ""
	@echo "Scenario 7: Multipath Failure Test"
	./$(ERROR_TEST_BINARY) -scenario=multipath-failure -verbose -output=$(RESULTS_DIR)/multipath.json
	@echo ""
	@echo "Scenario 8: FEC Recovery Test"
	./$(ERROR_TEST_BINARY) -scenario=fec-recovery -verbose -output=$(RESULTS_DIR)/fec.json
	@echo ""
	@echo "Scenario 9: Extreme Conditions Test"
	./$(ERROR_TEST_BINARY) -scenario=extreme-conditions -verbose -output=$(RESULTS_DIR)/extreme.json
	@echo ""
	@echo "âœ… All error testing scenarios completed"

test-network-stress: build-error-test ## Ð¢ÐµÑÑ‚: ÑÐµÑ‚ÐµÐ²Ñ‹Ðµ ÑÑ‚Ñ€ÐµÑÑÐ¾Ð²Ñ‹Ðµ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ
	@echo "ðŸŒ Testing network stress conditions..."
	./$(ERROR_TEST_BINARY) -scenario=network-stress -verbose -output=$(RESULTS_DIR)/network-stress.json

test-quic-errors: build-error-test ## Ð¢ÐµÑÑ‚: Ð¾ÑˆÐ¸Ð±ÐºÐ¸ QUIC Ð¿Ñ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð»Ð°
	@echo "ðŸ”§ Testing QUIC protocol errors..."
	./$(ERROR_TEST_BINARY) -scenario=quic-protocol-errors -verbose -output=$(RESULTS_DIR)/quic-protocol.json

test-experimental-errors: build-error-test ## Ð¢ÐµÑÑ‚: Ð¾ÑˆÐ¸Ð±ÐºÐ¸ ÑÐºÑÐ¿ÐµÑ€Ð¸Ð¼ÐµÐ½Ñ‚Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹
	@echo "ðŸš€ Testing experimental features errors..."
	./$(ERROR_TEST_BINARY) -scenario=experimental-features -verbose -output=$(RESULTS_DIR)/experimental.json

test-high-latency: build-error-test ## Ð¢ÐµÑÑ‚: Ð²Ñ‹ÑÐ¾ÐºÐ¸Ðµ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¸
	@echo "â±ï¸ Testing high latency conditions..."
	./$(ERROR_TEST_BINARY) -scenario=high-latency-network -verbose -output=$(RESULTS_DIR)/high-latency.json

test-unstable-connection: build-error-test ## Ð¢ÐµÑÑ‚: Ð½ÐµÑÑ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ðµ ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ
	@echo "ðŸ”Œ Testing unstable connections..."
	./$(ERROR_TEST_BINARY) -scenario=unstable-connection -verbose -output=$(RESULTS_DIR)/unstable.json

test-cc-stress: build-error-test ## Ð¢ÐµÑÑ‚: ÑÑ‚Ñ€ÐµÑÑ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼Ð¾Ð² ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿ÐµÑ€ÐµÐ³Ñ€ÑƒÐ·ÐºÐ¾Ð¹
	@echo "ðŸ“Š Testing congestion control stress..."
	./$(ERROR_TEST_BINARY) -scenario=congestion-control-stress -verbose -output=$(RESULTS_DIR)/cc-stress.json

test-multipath-failure: build-error-test ## Ð¢ÐµÑÑ‚: Ð¾Ñ‚ÐºÐ°Ð·Ñ‹ multipath
	@echo "ðŸ›¤ï¸ Testing multipath failures..."
	./$(ERROR_TEST_BINARY) -scenario=multipath-failure -verbose -output=$(RESULTS_DIR)/multipath.json

test-fec-recovery: build-error-test ## Ð¢ÐµÑÑ‚: Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ FEC
	@echo "ðŸ”§ Testing FEC recovery..."
	./$(ERROR_TEST_BINARY) -scenario=fec-recovery -verbose -output=$(RESULTS_DIR)/fec.json

test-extreme-conditions: build-error-test ## Ð¢ÐµÑÑ‚: ÑÐºÑÑ‚Ñ€ÐµÐ¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÑƒÑÐ»Ð¾Ð²Ð¸Ñ
	@echo "ðŸŒªï¸ Testing extreme conditions..."
	./$(ERROR_TEST_BINARY) -scenario=extreme-conditions -verbose -output=$(RESULTS_DIR)/extreme.json

# ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ðµ Ñ‚ÐµÑÑ‚Ñ‹
test-custom: build-error-test ## Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¹ Ñ‚ÐµÑÑ‚ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
	@echo "ðŸŽ¯ Running custom error test..."
	./$(ERROR_TEST_BINARY) -duration=5m -concurrent=10 -packet-loss=0.1 -verbose -output=$(RESULTS_DIR)/custom.json

test-quick: build-error-test ## Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ñ‚ÐµÑÑ‚ Ð¾ÑˆÐ¸Ð±Ð¾Ðº (2 Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹)
	@echo "âš¡ Running quick error test..."
	./$(ERROR_TEST_BINARY) -duration=2m -concurrent=3 -packet-loss=0.05 -verbose -output=$(RESULTS_DIR)/quick.json

test-heavy: build-error-test ## Ð¢ÑÐ¶ÐµÐ»Ñ‹Ð¹ Ñ‚ÐµÑÑ‚ Ð¾ÑˆÐ¸Ð±Ð¾Ðº (10 Ð¼Ð¸Ð½ÑƒÑ‚)
	@echo "ðŸ’ª Running heavy error test..."
	./$(ERROR_TEST_BINARY) -duration=10m -concurrent=20 -packet-loss=0.2 -verbose -output=$(RESULTS_DIR)/heavy.json

# ÐÐ½Ð°Ð»Ð¸Ð· Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²
analyze-results: ## ÐÐ½Ð°Ð»Ð¸Ð· Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
	@echo "ðŸ“Š Analyzing error testing results..."
	@if [ -d "$(RESULTS_DIR)" ] && [ "$$(ls -A $(RESULTS_DIR) 2>/dev/null)" ]; then \
		echo "Found results in $(RESULTS_DIR):"; \
		ls -la $(RESULTS_DIR)/*.json 2>/dev/null || echo "No result files found"; \
		echo ""; \
		echo "Results analysis:"; \
		for file in $(RESULTS_DIR)/*.json; do \
			if [ -f "$$file" ]; then \
				echo "  - $$(basename $$file): $$(wc -l < $$file) lines"; \
			fi; \
		done; \
	else \
		echo "No results found in $(RESULTS_DIR)"; \
		echo "Run error tests first to generate results"; \
	fi

# Ð”ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
demo-error-testing: build-error-test ## Ð”ÐµÐ¼Ð¾: Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
	@echo "ðŸŽ¬ Demo: Error Testing"
	@echo "====================="
	@echo ""
	@echo "1. Quick network stress test..."
	./$(ERROR_TEST_BINARY) -duration=1m -concurrent=5 -packet-loss=0.05 -verbose
	@echo ""
	@echo "2. QUIC protocol error test..."
	./$(ERROR_TEST_BINARY) -scenario=quic-protocol-errors -duration=1m -verbose
	@echo ""
	@echo "3. Experimental features error test..."
	./$(ERROR_TEST_BINARY) -scenario=experimental-features -duration=1m -verbose
	@echo ""
	@echo "Demo completed. Check results for error handling effectiveness."

demo-recovery-testing: build-error-test ## Ð”ÐµÐ¼Ð¾: Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ
	@echo "ðŸŽ¬ Demo: Recovery Testing"
	@echo "========================"
	@echo ""
	@echo "Testing recovery from various error conditions..."
	@echo ""
	@echo "1. Network recovery test..."
	./$(ERROR_TEST_BINARY) -duration=2m -packet-loss=0.1 -connection-drops=true -verbose
	@echo ""
	@echo "2. QUIC recovery test..."
	./$(ERROR_TEST_BINARY) -scenario=quic-protocol-errors -duration=2m -verbose
	@echo ""
	@echo "3. Multipath recovery test..."
	./$(ERROR_TEST_BINARY) -scenario=multipath-failure -duration=2m -verbose
	@echo ""
	@echo "Demo completed. Analyze recovery times and success rates."

# Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÑÑ‚Ñ‹
test-packet-loss: build-error-test ## Ð¢ÐµÑÑ‚: Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ ÑƒÑ€Ð¾Ð²Ð½Ð¸ Ð¿Ð¾Ñ‚ÐµÑ€Ð¸ Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²
	@echo "ðŸ“¦ Testing packet loss scenarios..."
	@echo "Low loss (1%)..."
	./$(ERROR_TEST_BINARY) -packet-loss=0.01 -duration=2m -verbose -output=$(RESULTS_DIR)/loss-1pct.json
	@echo "Medium loss (5%)..."
	./$(ERROR_TEST_BINARY) -packet-loss=0.05 -duration=2m -verbose -output=$(RESULTS_DIR)/loss-5pct.json
	@echo "High loss (10%)..."
	./$(ERROR_TEST_BINARY) -packet-loss=0.10 -duration=2m -verbose -output=$(RESULTS_DIR)/loss-10pct.json
	@echo "Extreme loss (20%)..."
	./$(ERROR_TEST_BINARY) -packet-loss=0.20 -duration=2m -verbose -output=$(RESULTS_DIR)/loss-20pct.json

test-latency-scenarios: build-error-test ## Ð¢ÐµÑÑ‚: Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¸ Ð·Ð°Ð´ÐµÑ€Ð¶ÐµÐº
	@echo "â±ï¸ Testing latency scenarios..."
	@echo "Low latency (10ms variation)..."
	./$(ERROR_TEST_BINARY) -latency-var=10ms -duration=2m -verbose -output=$(RESULTS_DIR)/latency-10ms.json
	@echo "Medium latency (50ms variation)..."
	./$(ERROR_TEST_BINARY) -latency-var=50ms -duration=2m -verbose -output=$(RESULTS_DIR)/latency-50ms.json
	@echo "High latency (200ms variation)..."
	./$(ERROR_TEST_BINARY) -latency-var=200ms -duration=2m -verbose -output=$(RESULTS_DIR)/latency-200ms.json
	@echo "Extreme latency (500ms variation)..."
	./$(ERROR_TEST_BINARY) -latency-var=500ms -duration=2m -verbose -output=$(RESULTS_DIR)/latency-500ms.json

test-concurrent-load: build-error-test ## Ð¢ÐµÑÑ‚: Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ ÑƒÑ€Ð¾Ð²Ð½Ð¸ ÐºÐ¾Ð½ÐºÑƒÑ€ÐµÐ½Ñ‚Ð½Ð¾Ð¹ Ð½Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸
	@echo "ðŸ‘¥ Testing concurrent load scenarios..."
	@echo "Low concurrency (3 tests)..."
	./$(ERROR_TEST_BINARY) -concurrent=3 -duration=2m -verbose -output=$(RESULTS_DIR)/concurrent-3.json
	@echo "Medium concurrency (10 tests)..."
	./$(ERROR_TEST_BINARY) -concurrent=10 -duration=2m -verbose -output=$(RESULTS_DIR)/concurrent-10.json
	@echo "High concurrency (20 tests)..."
	./$(ERROR_TEST_BINARY) -concurrent=20 -duration=2m -verbose -output=$(RESULTS_DIR)/concurrent-20.json
	@echo "Extreme concurrency (50 tests)..."
	./$(ERROR_TEST_BINARY) -concurrent=50 -duration=2m -verbose -output=$(RESULTS_DIR)/concurrent-50.json

# Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð°Ñ†Ð¸Ñ Ñ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ð¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð¾Ð¼
integrate-error-testing: ## Ð˜Ð½Ñ‚ÐµÐ³Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð² Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚
	@echo "ðŸ”— Integrating error testing into main project..."
	@echo ""
	@echo "1. Adding error testing to CI/CD pipeline..."
	@echo "2. Creating error testing documentation..."
	@echo "3. Setting up automated error testing..."
	@echo ""
	@echo "âœ… Error testing integration completed"
	@echo "Use 'make test-error-scenarios' to run error tests"

# Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ
docs-error-testing: ## Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ Ð¿Ð¾ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
	@echo "ðŸ“š Generating error testing documentation..."
	@echo ""
	@echo "Error Testing Scenarios:"
	@echo "======================="
	@echo ""
	@echo "1. Network Stress Test:"
	@echo "   - High packet loss (5%)"
	@echo "   - Packet duplication (2%)"
	@echo "   - Packet reordering"
	@echo "   - Packet corruption (1%)"
	@echo "   - Connection drops"
	@echo ""
	@echo "2. QUIC Protocol Error Test:"
	@echo "   - Stream errors"
	@echo "   - Handshake errors"
	@echo "   - Version negotiation errors"
	@echo "   - Protocol violations"
	@echo ""
	@echo "3. Experimental Features Error Test:"
	@echo "   - ACK frequency errors"
	@echo "   - Congestion control errors"
	@echo "   - Multipath errors"
	@echo "   - FEC errors"
	@echo ""
	@echo "4. High Latency Network Test:"
	@echo "   - High latency variation (200ms)"
	@echo "   - High jitter (50ms)"
	@echo "   - Connection drops"
	@echo "   - Handshake timeouts"
	@echo ""
	@echo "5. Unstable Connection Test:"
	@echo "   - High packet loss (8%)"
	@echo "   - Packet duplication (5%)"
	@echo "   - Packet reordering"
	@echo "   - Packet corruption (3%)"
	@echo "   - Frequent connection drops"
	@echo ""
	@echo "6. Congestion Control Stress Test:"
	@echo "   - High packet loss (10%)"
	@echo "   - Packet reordering"
	@echo "   - CC algorithm errors"
	@echo "   - ACK frequency errors"
	@echo ""
	@echo "7. Multipath Failure Test:"
	@echo "   - Path failures"
	@echo "   - Load balancing errors"
	@echo "   - Stream distribution errors"
	@echo "   - Connection drops"
	@echo ""
	@echo "8. FEC Recovery Test:"
	@echo "   - High packet loss (20%)"
	@echo "   - Packet corruption (5%)"
	@echo "   - FEC algorithm errors"
	@echo "   - Recovery testing"
	@echo ""
	@echo "9. Extreme Conditions Test:"
	@echo "   - All error types enabled"
	@echo "   - High error rates"
	@echo "   - Long duration (10 minutes)"
	@echo "   - High concurrency (15 tests)"

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ°
clean-error-test: ## ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ñ„Ð°Ð¹Ð»Ñ‹ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
	@echo "ðŸ§¹ Cleaning error testing files..."
	rm -f $(ERROR_TEST_BINARY)
	rm -rf $(RESULTS_DIR)
	@echo "âœ… Error testing files cleaned"

# Ð’ÑÐµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
all-error-tests: clean-error-test build-error-test test-error-scenarios ## Ð’Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
	@echo "ðŸŽ‰ All error testing completed!"
	@echo "Check results in $(RESULTS_DIR)/ directory"

