#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è DevOps –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π QUIC —Å–µ—Ä–≤–µ—Ä–∞
# –û—Å–Ω–æ–≤–∞–Ω –Ω–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è—Ö DevOps –∫–æ–º–∞–Ω–¥—ã

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

echo -e "${BLUE}==========================================${NC}"
echo -e "${BLUE}  2GC Network Protocol Suite - DevOps Optimizations${NC}"
echo "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π QUIC —Å–µ—Ä–≤–µ—Ä–∞"
echo ""

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
apply_system_optimizations() {
    echo -e "${YELLOW}üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π...${NC}"
    
    # UDP –±—É—Ñ–µ—Ä—ã
    echo -e "${CYAN}üì° –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UDP –±—É—Ñ–µ—Ä–æ–≤:${NC}"
    sudo sysctl -w net.core.rmem_max=134217728 >/dev/null 2>&1
    sudo sysctl -w net.core.rmem_default=134217728 >/dev/null 2>&1
    sudo sysctl -w net.core.wmem_max=134217728 >/dev/null 2>&1
    sudo sysctl -w net.core.wmem_default=134217728 >/dev/null 2>&1
    echo "  ‚úÖ UDP –±—É—Ñ–µ—Ä—ã —É–≤–µ–ª–∏—á–µ–Ω—ã –¥–æ 128MB"
    
    # –°–µ—Ç–µ–≤—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    echo -e "${CYAN}üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:${NC}"
    sudo sysctl -w net.core.netdev_max_backlog=5000 >/dev/null 2>&1
    sudo sysctl -w net.core.somaxconn=65535 >/dev/null 2>&1
    sudo sysctl -w net.ipv4.udp_mem="102400 873800 16777216" >/dev/null 2>&1
    sudo sysctl -w net.ipv4.udp_rmem_min=8192 >/dev/null 2>&1
    sudo sysctl -w net.ipv4.udp_wmem_min=8192 >/dev/null 2>&1
    echo "  ‚úÖ –°–µ—Ç–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã"
    
    # TCP –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    echo -e "${CYAN}üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ TCP –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:${NC}"
    sudo sysctl -w net.ipv4.tcp_congestion_control=bbr >/dev/null 2>&1
    sudo sysctl -w net.ipv4.tcp_rmem="4096 87380 134217728" >/dev/null 2>&1
    sudo sysctl -w net.ipv4.tcp_wmem="4096 65536 134217728" >/dev/null 2>&1
    echo "  ‚úÖ TCP congestion control: BBR"
    echo "  ‚úÖ TCP –±—É—Ñ–µ—Ä—ã –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–∏–º–∏—Ç–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
setup_process_limits() {
    echo -e "${YELLOW}‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤...${NC}"
    
    # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã –¥–ª—è —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
    ulimit -n 65536 2>/dev/null
    ulimit -u 32768 2>/dev/null
    
    echo "  ‚úÖ –õ–∏–º–∏—Ç—ã —Ñ–∞–π–ª–æ–≤: 65536"
    echo "  ‚úÖ –õ–∏–º–∏—Ç—ã –ø—Ä–æ—Ü–µ—Å—Å–æ–≤: 32768"
    
    # –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
    echo -e "${CYAN}üìù –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ª–∏–º–∏—Ç–æ–≤:${NC}"
    cat > /tmp/quic-limits.conf << EOF
# QUIC Server Process Limits
quic-server soft nofile 65536
quic-server hard nofile 65536
quic-server soft nproc 32768
quic-server hard nproc 32768
EOF
    
    echo "  ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ª–∏–º–∏—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–∞: /tmp/quic-limits.conf"
    echo "  üí° –î–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –¥–æ–±–∞–≤—å—Ç–µ –≤ /etc/security/limits.conf"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
create_optimized_server() {
    echo -e "${YELLOW}üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞...${NC}"
    
    # –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
    cat > scripts/optimized-server-start.sh << 'EOF'
#!/bin/bash

# –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ QUIC —Å–µ—Ä–≤–µ—Ä–∞
# –ü—Ä–∏–º–µ–Ω—è–µ—Ç –≤—Å–µ DevOps —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}==========================================${NC}"
echo -e "${BLUE}  2GC Network Protocol Suite - Optimized Server${NC}"
echo "–ó–∞–ø—É—Å–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ QUIC —Å–µ—Ä–≤–µ—Ä–∞"
echo ""

# –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
echo -e "${YELLOW}üîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π...${NC}"
sudo sysctl -w net.core.rmem_max=134217728 >/dev/null 2>&1
sudo sysctl -w net.core.wmem_max=134217728 >/dev/null 2>&1
sudo sysctl -w net.core.netdev_max_backlog=5000 >/dev/null 2>&1
sudo sysctl -w net.ipv4.tcp_congestion_control=bbr >/dev/null 2>&1

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
ulimit -n 65536 2>/dev/null
ulimit -u 32768 2>/dev/null

echo -e "${GREEN}‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã${NC}"

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
echo -e "${YELLOW}üöÄ –ó–∞–ø—É—Å–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞...${NC}"

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
export QUIC_MAX_CONNECTIONS=1000
export QUIC_MAX_RATE_PER_CONN=20
export QUIC_CONNECTION_TIMEOUT=60s
export QUIC_HANDSHAKE_TIMEOUT=10s
export QUIC_KEEP_ALIVE=30s
export QUIC_MAX_STREAMS=100
export QUIC_ENABLE_DATAGRAMS=true
export QUIC_ENABLE_0RTT=true
export QUIC_MONITORING=true

# –ó–∞–ø—É—Å–∫–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
timeout 10m docker run --rm --name 2gc-network-server-optimized \
    --network 2gc-network-suite \
    -p 9000:9000/udp \
    -p 2113:2113 \
    -p 6060:6060 \
    -e QUIC_MAX_CONNECTIONS=$QUIC_MAX_CONNECTIONS \
    -e QUIC_MAX_RATE_PER_CONN=$QUIC_MAX_RATE_PER_CONN \
    -e QUIC_CONNECTION_TIMEOUT=$QUIC_CONNECTION_TIMEOUT \
    -e QUIC_HANDSHAKE_TIMEOUT=$QUIC_HANDSHAKE_TIMEOUT \
    -e QUIC_KEEP_ALIVE=$QUIC_KEEP_ALIVE \
    -e QUIC_MAX_STREAMS=$QUIC_MAX_STREAMS \
    -e QUIC_ENABLE_DATAGRAMS=$QUIC_ENABLE_DATAGRAMS \
    -e QUIC_ENABLE_0RTT=$QUIC_ENABLE_0RTT \
    -e QUIC_MONITORING=$QUIC_MONITORING \
    2gc-network-suite:server

echo -e "${GREEN}‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É${NC}"
EOF

    chmod +x scripts/optimized-server-start.sh
    echo "  ‚úÖ –°–∫—Ä–∏–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ —Å–æ–∑–¥–∞–Ω: scripts/optimized-server-start.sh"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è health check —Å–∫—Ä–∏–ø—Ç–∞
create_health_check() {
    echo -e "${YELLOW}üè• –°–æ–∑–¥–∞–Ω–∏–µ health check —Å–∫—Ä–∏–ø—Ç–∞...${NC}"
    
    cat > scripts/health-check.sh << 'EOF'
#!/bin/bash

# Health check –¥–ª—è QUIC —Å–µ—Ä–≤–µ—Ä–∞
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–æ–Ω—ã –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

SERVER_URL="http://localhost:2113/metrics"
CRITICAL_ZONE_ALERT=false
WARNINGS=0

echo -e "${BLUE}==========================================${NC}"
echo -e "${BLUE}  QUIC Server Health Check${NC}"
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞
if ! curl -s $SERVER_URL >/dev/null 2>&1; then
    echo -e "${RED}‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω${NC}"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫—É—é –∑–æ–Ω—É (26-35 pps)
echo -e "${YELLOW}üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –∑–æ–Ω—ã...${NC}"
RATE=$(curl -s $SERVER_URL 2>/dev/null | grep 'quic_server_rate_per_connection' | awk '{print $2}' | head -1)

if [ -n "$RATE" ] && (( $(echo "$RATE >= 26 && $RATE <= 35" | bc -l 2>/dev/null || echo "0") )); then
    echo -e "${RED}üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ó–û–ù–ê: Rate $RATE pps (26-35 pps)${NC}"
    CRITICAL_ZONE_ALERT=true
    WARNINGS=$((WARNINGS + 1))
elif [ -n "$RATE" ]; then
    echo -e "${GREEN}‚úÖ Rate $RATE pps (–±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞)${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º jitter
echo -e "${YELLOW}üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ jitter...${NC}"
JITTER=$(curl -s $SERVER_URL 2>/dev/null | grep 'quic_server_jitter_seconds' | awk '{print $2}' | head -1)

if [ -n "$JITTER" ] && (( $(echo "$JITTER > 0.1" | bc -l 2>/dev/null || echo "0") )); then
    echo -e "${RED}‚ö†Ô∏è –í—ã—Å–æ–∫–∏–π jitter: $JITTER —Å–µ–∫—É–Ω–¥${NC}"
    WARNINGS=$((WARNINGS + 1))
elif [ -n "$JITTER" ]; then
    echo -e "${GREEN}‚úÖ Jitter: $JITTER —Å–µ–∫—É–Ω–¥ (–Ω–æ—Ä–º–∞)${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—à–∏–±–∫–∏
echo -e "${YELLOW}‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—à–∏–±–æ–∫...${NC}"
ERRORS=$(curl -s $SERVER_URL 2>/dev/null | grep 'quic_server_errors_total' | awk '{print $2}' | head -1)

if [ -n "$ERRORS" ] && (( $(echo "$ERRORS > 10" | bc -l 2>/dev/null || echo "0") )); then
    echo -e "${RED}‚ö†Ô∏è –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –æ—à–∏–±–æ–∫: $ERRORS${NC}"
    WARNINGS=$((WARNINGS + 1))
elif [ -n "$ERRORS" ]; then
    echo -e "${GREEN}‚úÖ –û—à–∏–±–∫–∏: $ERRORS (–Ω–æ—Ä–º–∞)${NC}"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
echo -e "${YELLOW}üîó –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π...${NC}"
CONNECTIONS=$(curl -s $SERVER_URL 2>/dev/null | grep 'quic_server_connections_total' | awk '{print $2}' | head -1)

if [ -n "$CONNECTIONS" ]; then
    echo -e "${GREEN}‚úÖ –ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π: $CONNECTIONS${NC}"
fi

# –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å
echo ""
echo -e "${BLUE}==========================================${NC}"

if [ "$CRITICAL_ZONE_ALERT" = true ]; then
    echo -e "${RED}üö® –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –°–û–°–¢–û–Ø–ù–ò–ï: –°–µ—Ä–≤–µ—Ä –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –∑–æ–Ω–µ${NC}"
    exit 1
elif [ $WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø: $WARNINGS –ø—Ä–æ–±–ª–µ–º –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ${NC}"
    exit 2
else
    echo -e "${GREEN}‚úÖ –°–ï–†–í–ï–† –í –ù–û–†–ú–ï: –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã${NC}"
    exit 0
fi
EOF

    chmod +x scripts/health-check.sh
    echo "  ‚úÖ Health check —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω: scripts/health-check.sh"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
create_monitoring() {
    echo -e "${YELLOW}üìä –°–æ–∑–¥–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞...${NC}"
    
    # –°–æ–∑–¥–∞–µ–º Prometheus alerts
    cat > prometheus/alerts.yml << 'EOF'
groups:
- name: quic-server
  rules:
  - alert: QUICCriticalZone
    expr: quic_server_rate_per_connection >= 26 and quic_server_rate_per_connection <= 35
    for: 10s
    labels:
      severity: critical
    annotations:
      summary: "QUIC server in critical performance zone"
      description: "Server rate {{ $value }} pps is in critical zone (26-35 pps)"
  
  - alert: QUICHighJitter
    expr: histogram_quantile(0.95, quic_server_jitter_seconds) > 0.1
    for: 30s
    labels:
      severity: warning
    annotations:
      summary: "QUIC server high jitter detected"
      description: "Server jitter p95 is {{ $value }}s"
  
  - alert: QUICHighErrorRate
    expr: rate(quic_server_errors_total[5m]) / rate(quic_server_packets_total[5m]) > 0.01
    for: 1m
    labels:
      severity: warning
    annotations:
      summary: "QUIC server high error rate"
      description: "Server error rate is {{ $value }}%"
EOF

    echo "  ‚úÖ Prometheus alerts —Å–æ–∑–¥–∞–Ω—ã: prometheus/alerts.yml"
    
    # –°–æ–∑–¥–∞–µ–º Grafana dashboard
    cat > grafana/dashboards/quic-optimization.json << 'EOF'
{
  "dashboard": {
    "title": "QUIC Server Optimization Dashboard",
    "panels": [
      {
        "title": "Connection Rate (Critical Zone Detection)",
        "type": "graph",
        "targets": [
          {
            "expr": "quic_server_rate_per_connection",
            "legendFormat": "Rate (pps)"
          }
        ],
        "yAxes": [
          {
            "min": 0,
            "max": 50
          }
        ],
        "thresholds": [
          {
            "value": 26,
            "colorMode": "critical",
            "op": "gt"
          },
          {
            "value": 35,
            "colorMode": "critical",
            "op": "lt"
          }
        ]
      },
      {
        "title": "Jitter (ms)",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, quic_server_jitter_seconds) * 1000",
            "legendFormat": "Jitter P95 (ms)"
          }
        ]
      },
      {
        "title": "Error Rate (%)",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(quic_server_errors_total[5m]) / rate(quic_server_packets_total[5m]) * 100",
            "legendFormat": "Error Rate (%)"
          }
        ]
      }
    ]
  }
}
EOF

    echo "  ‚úÖ Grafana dashboard —Å–æ–∑–¥–∞–Ω: grafana/dashboards/quic-optimization.json"
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    echo -e "${GREEN}üöÄ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ DevOps –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π...${NC}"
    echo ""
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    apply_system_optimizations
    
    echo ""
    
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ª–∏–º–∏—Ç—ã –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    setup_process_limits
    
    echo ""
    
    # –°–æ–∑–¥–∞–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä
    create_optimized_server
    
    echo ""
    
    # –°–æ–∑–¥–∞–µ–º health check
    create_health_check
    
    echo ""
    
    # –°–æ–∑–¥–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
    create_monitoring
    
    echo ""
    echo -e "${BLUE}==========================================${NC}"
    echo -e "${GREEN}‚úÖ DevOps –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!${NC}"
    echo ""
    echo -e "${BLUE}üìã –°–æ–∑–¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:${NC}"
    echo "  üîß scripts/optimized-server-start.sh - –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä"
    echo "  üè• scripts/health-check.sh - Health check"
    echo "  üìä prometheus/alerts.yml - Prometheus –∞–ª–µ—Ä—Ç—ã"
    echo "  üìà grafana/dashboards/quic-optimization.json - Grafana –¥–∞—à–±–æ—Ä–¥"
    echo ""
    echo -e "${BLUE}üöÄ –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:${NC}"
    echo "  –ó–∞–ø—É—Å–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞: ./scripts/optimized-server-start.sh"
    echo "  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è: ./scripts/health-check.sh"
    echo "  –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥: ./scripts/live-monitor.sh"
    echo ""
    echo -e "${YELLOW}üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:${NC}"
    echo "  1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞"
    echo "  2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–æ–Ω"
    echo "  3. –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ health check"
    echo "  4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–æ–Ω"
}

# –ó–∞–ø—É—Å–∫
main "$@"
